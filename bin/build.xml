<?xml version="1.0" encoding="UTF-8"?>
<project name="Build-Project" default="help" basedir="../">

    <!--
        Project Build file.
        This file contains all build workflow steps necessary to create a development setup for the Project project.
    -->
    <tstamp />

    <!-- set the operating system properties -->
    <condition property="build.os" value="mac">

        <os family="mac" />
    </condition>

    <condition property="build.os" value="windows">

        <os family="windows" />
    </condition>

    <condition property="build.os" value="linux">

        <and>

            <os family="unix"/>
            <not>

                <os family="mac"/>
            </not>
        </and>
    </condition>

    <!-- Include os specific build properties file. -->

    <property file="config/${build.os}/dev/build.properties" />

    <!-- Figure out what build system we will be using -->

    <condition property="use.unix-make">

        <contains string="${cmake.generator}" substring="Makefiles" />
    </condition>

    <condition property="use.vs">

        <contains string="${cmake.generator}" substring="Visual Studio" />
    </condition>

    <condition property="use.xcode">

        <contains string="${cmake.generator}" substring="Xcode" />
    </condition>

    <!--
        Help target.
        Shows the general tasks available.
    -->
    <target name="help" description="Show this menu.">

        <java classname="org.apache.tools.ant.Main">
            <arg value="-projecthelp"/>
        </java>
    </target>

    <!--
        Build target.
        Runs through complete workflow to create a compiled product.
    -->
    <target name="build" description="Build Project." depends="prepare,configure,make,make-install,package" />

    <!--
        Release target.
        Runs through complete workflow to create a released product.
    -->
    <target name="release" description="Build Project." depends="build,publish" />

    <!--
        Prepare target.
        Cleans out the build folder and bootstraps the cmake cache file.
    -->
    <target name="prepare" description="Prepare files and folders." depends="log,clean,bootstrap" />

    <target name="log">

        <!-- Create build directories -->
        <mkdir dir="${dir.log}"/>

        <record name="${dir.log}/${log.file}" loglevel="${log.level}" />

        <echo message="os type      : ${os.name}" />
        <echo message="os arch      : ${os.arch}" />
        <echo message="os version   : ${os.version}" />
        <echo message="build system : ${cmake.generator}" />
        <echo message="build type   : ${cmake.build.type}" />
        <echo message="branch       : ${branch.name}" />
        <echo message="build dir    : ${dir.build}" />
        <echo message="data dir     : ${dir.data}" />
        <echo message="doc dir      : ${dir.doc}" />
        <echo message="log dir      : ${dir.log}" />
        <echo message="package dir  : ${dir.package}" />
        <echo message="scripts dir  : ${dir.scripts}" />
        <echo message="src dir      : ${dir.src}" />
    </target>

    <target name="clean">

        <!-- Flush build and package directories -->
        <delete dir="${dir.build}/${build.os}/${branch.name}"/>
        <delete dir="${dir.package}/${build.os}/${branch.name}"/>

        <!-- Create build and package directories -->
        <mkdir dir="${dir.build}/${build.os}/${branch.name}"/>
        <mkdir dir="${dir.package}/${build.os}/${branch.name}"/>
    </target>

    <target name="bootstrap" depends="bootstrap-unixmake,bootstrap-vs,bootstrap-xcode">

        <!-- Copy cmake cache file -->
        <copy file="${cmake.cache.file}" todir="${dir.build}/${build.os}/${branch.name}" />
    </target>

    <target name="bootstrap-unixmake" if="use.unix-make" />

    <target name="bootstrap-vs" if="use.vs" />

    <target name="bootstrap-xcode" if="use.xcode" />

    <!--
        Configure target.
        Generate platform specific make files.
    -->
    <target name="configure" description="Configure Culgi using cmake.">

        <!-- configure project -->
        <exec dir="${dir.build}/${build.os}/${branch.name}" executable="${cmake.bin}" failonerror="true">
            <arg value="-G${cmake.generator}"/>
            <arg value="${dir.src}/${branch.name}"/>
        </exec>
    </target>

    <!--
        Make target.
        Build Culgi in a platform appropriate way.
    -->
    <target name="make" description="Compile Culgi." depends="make-unixmake,make-vs,make-xcode" />

    <target name="make-unixmake" if="use.unix-make">

        <!-- build project -->
        <exec dir="${dir.build}/${build.os}/${branch.name}" executable="make" failonerror="true">
            <arg value="-i"/>
            <arg value="-j${cmake.cores}"/>
        </exec>
    </target>

    <target name="make-vs" if="use.vs">

        <!-- build project -->
        <antcall target="run-vs">
            <param name="target" value="ALL_BUILD"/>
        </antcall>
    </target>

    <target name="make-xcode" if="use.xcode">

        <!-- build project -->
        <antcall target="run-xcode">
            <param name="target" value="ALL_BUILD"/>
        </antcall>
    </target>

    <!--
        Test target.
        Run test suite for Culgi.
    -->
    <target name="test" description="Testing of Culgi." depends="test-unixmake,test-vs,test-xcode" />

    <target name="test-unixmake" if="use.unix-make">

        <!-- test project -->
        <exec dir="${dir.build}/${build.os}/${branch.name}" executable="make" failonerror="true">
            <arg value="test"/>
        </exec>
    </target>

    <target name="test-vs" if="use.vs">

        <!-- test project -->
        <antcall target="run-vs">
            <param name="target" value="RUN_TESTS"/>
        </antcall>
    </target>

    <target name="test-xcode" if="use.xcode">

        <!-- test project -->
        <antcall target="run-xcode">
            <param name="target" value="RUN_TESTS"/>
        </antcall>
    </target>

    <!--
        Doxygen target.
        Create documentation for project.
    -->
    <target name="doxygen" description="doxygening of project." depends="doxygen-unixmake,doxygen-vs,doxygen-xcode" />

    <target name="doxygen-unixmake" if="use.unix-make">

        <!-- create documentation -->
        <exec dir="${dir.tmp}/build/${os.name}" executable="make" failonerror="true">
            <arg value="doxygen"/>
        </exec>
    </target>

    <target name="doxygen-vs" if="use.vs">

        <!-- create documentation -->
        <antcall target="run-vs">
            <param name="target" value="doxygen"/>
        </antcall>
    </target>

    <target name="doxygen-xcode" if="use.xcode">

        <!-- create documentation -->
        <antcall target="run-xcode">
            <param name="target" value="doxygen"/>
        </antcall>
    </target>

    <!--
        Make install target.
        Install Project from compiled code.
    -->
    <target name="make-install" description="Install of Project." depends="make-install-unixmake,make-install-vs,make-install-xcode" />

    <target name="make-install-unixmake" if="use.unix-make">

        <!-- install project -->
        <exec dir="${dir.build}/${build.os}/dev" executable="make" failonerror="true">
            <arg value="install"/>
        </exec>
    </target>

    <target name="make-install-vs" if="use.vs">

        <!-- install project -->
        <antcall target="run-vs">
            <param name="target" value="INSTALL"/>
        </antcall>
    </target>

    <target name="make-install-xcode" if="use.xcode">

        <!-- install project -->
        <antcall target="run-xcode">
            <param name="target" value="install"/>
        </antcall>
    </target>

    <!--
        Package target.
        Create platform specific installer for Project from compiled code.
    -->
    <target name="package" description="Install of Attgenie." depends="package-unixmake,package-vs,package-xcode" />

    <target name="package-unixmake" if="use.unix-make">

        <!-- package project -->
        <exec dir="${dir.build}/${build.os}/dev" executable="make" failonerror="true">
            <arg value="package"/>
        </exec>
    </target>

    <target name="package-vs" if="use.vs">

        <!-- package project -->
        <antcall target="run-vs">
            <param name="target" value="PACKAGE"/>
        </antcall>
    </target>

    <target name="package-xcode" if="use.xcode">

        <!-- package project -->
        <antcall target="run-xcode">
            <param name="target" value="package"/>
        </antcall>
    </target>

    <!--
        Publish target.
        Publish platform specific installer for Culgi from compiled code.
    -->
    <target name="publish" description="Publish Culgi." />

    <target name="run-vs" if="use.vs">

        <exec dir="${dir.build}/${build.os}/${branch.name}" executable="${dir.scripts}/run-vs.bat" failonerror="true">
            <arg value="${vs.bin}"/>
            <arg value="${cmake.project.name}"/>
            <arg value="${cmake.build.type}"/>
            <arg value="${target}"/>
        </exec>
    </target>

    <target name="run-xcode" if="use.xcode">

        <exec dir="${dir.build}/${build.os}/${branch.name}" executable="${dir.scripts}/run-xcode.sh" failonerror="true">
            <arg value="${cmake.build.type}"/>
            <arg value="${target}"/>
            <arg value="${cmake.cores}"/>
        </exec>
    </target>
</project>